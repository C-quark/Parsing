from bs4 import BeautifulSoup
import requests
import xlwings as xw
import pandas as pd

#exel = xw.Book('Парсинг калек.xlsx')
#list1 = exel.sheets['Лист1']
#table = list1.range('A1:G5000').options(pd.DataFrame, header = 1, index = False).value
#list1.range('A1:G1').value = ['Наименование', 'Цена', 'Москва', 'Санкт-Петербург', 'Новоcибирск', 'Товары в пути', 'Замена']
table = {'Наименование': [], 'Цена': [], 'Москва': [], 'Санкт-Петербург': [], 'Новосибирск': [], 'Екатеринбург': [], 'Товары в пути': [], 'Замена от производителя': []}

Programmable_controllers = "https://nnz-ipc.ru/catalogue/automation/controllers/"
Signal_input_output_modules = "https://nnz-ipc.ru/catalogue/automation/io/"
Signal_I_O_boards = "https://nnz-ipc.ru/catalogue/automation/io_boards/"
Modular_I_O_cages = "https://nnz-ipc.ru/catalogue/automation/extension_chassis/"
Specialized_modules = "https://nnz-ipc.ru/catalogue/automation/specialized_modules/"
Specialized_boards = "https://nnz-ipc.ru/catalogue/automation/specialized_boards/"
Operator_panels_HMI = "https://nnz-ipc.ru/catalogue/automation/hmi/"
IP_video_surveillance = "https://nnz-ipc.ru/catalogue/automation/video/"
Measurement_systems = "https://nnz-ipc.ru/catalogue/automation/remote_data_logger/"
L_card_equipment = "https://nnz-ipc.ru/catalogue/automation/lcard/"
Automation_accessories = "https://nnz-ipc.ru/catalogue/automation/automation_accesories/"
Industrial_Ethernet = "https://nnz-ipc.ru/catalogue/comm/ethernet/"
COM_Port_to_Ethernet_Converters = "https://nnz-ipc.ru/catalogue/comm/serial_to_ethernet/"
Multiport_RS_232_422_485_and_CAN_cards = "https://nnz-ipc.ru/catalogue/comm/serial/"
Wireless_access = "https://nnz-ipc.ru/catalogue/comm/wireless/"
Converters_and_repeaters = "https://nnz-ipc.ru/catalogue/comm/converters/"
Software = "https://nnz-ipc.ru/catalogue/comm/software/"
Accessories_for_switches = "https://nnz-ipc.ru/catalogue/comm/network_accesories/"
Accessories = "https://nnz-ipc.ru/catalogue/comm/accessories/"
Remote_Access_Tools = "https://nnz-ipc.ru/catalogue/dc_equipment/remote_access/"
Power_distribution = "https://nnz-ipc.ru/catalogue/dc_equipment/power_distribution/"
Dc_accessories = "https://nnz-ipc.ru/catalogue/dc_equipment/dc_accessories/"

ACS = [Programmable_controllers, Signal_input_output_modules, Signal_I_O_boards, Modular_I_O_cages, Specialized_modules, Specialized_boards, Operator_panels_HMI, IP_video_surveillance, Measurement_systems,
L_card_equipment, Automation_accessories, Industrial_Ethernet, COM_Port_to_Ethernet_Converters, Multiport_RS_232_422_485_and_CAN_cards, Wireless_access, Converters_and_repeaters, Software, Accessories_for_switches, Accessories,
Remote_Access_Tools, Power_distribution, Dc_accessories]

entry_count = 0

all_cities = set(['Москва', 'Санкт-Петербург', 'Новосибирск', 'Екатеринбург', 'Товары в пути', 'Замена от производителя'])

def add_cities(cities, values):
    for i in range(len(cities)):
        table[cities[i]].append(values[i])
    for city in all_cities.difference(set(cities)):
        table[city].append('0')

for ur in ACS:
    url = ur + "?pa=100"
    request = requests.get(url)

    soup = BeautifulSoup(request.text, "html.parser")

    entries = soup.find_all("div", class_ = "catcard_entry")
    if len(entries) == 0:
        break

    for entry in entries:
        entry_count = entry_count+1
        name = entry.find("meta", {"itemprop":"name"})
        price = entry.find("div", {"class":"catcard_price_strong"})
        stock = entry.find("ul", {"class":"avail_list"})
        if stock is not None:
            city_counts = stock.find_all("li")
            cities = []
            values = []
            for cc in city_counts:
                city = cc.find("span")
                count = cc.find("b")
                town = str(city.text)
                cities.append(town)
                values.append(str(count.text))
            add_cities(cities, values)
        else:
            add_cities([], [])

        table['Наименование'].append(str(name.get("content")))
        if price != None:
            table['Цена'].append(str(price.text))
        else:
            table['Цена'].append('нет цены')

print(entry_count)
print(table)
df = pd.DataFrame(table)
df.to_excel('parsing_NNC.xlsx')
